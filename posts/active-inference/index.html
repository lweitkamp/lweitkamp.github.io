<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.549">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Laurens Weitkamp">
<meta name="dcterms.date" content="2024-07-03">

<title>Notes on Active Inference</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="floating nav-fixed slimcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/lweitkamp/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/laurensweitkamp"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Notes on Active Inference</h1>
                      </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Laurens Weitkamp </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">July 3, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="99">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#the-bayesian-brain" id="toc-the-bayesian-brain" class="nav-link active" data-scroll-target="#the-bayesian-brain">The Bayesian Brain</a></li>
  <li><a href="#active-inference" id="toc-active-inference" class="nav-link" data-scroll-target="#active-inference">Active Inference</a></li>
  <li><a href="#past-present-variational-free-energy" id="toc-past-present-variational-free-energy" class="nav-link" data-scroll-target="#past-present-variational-free-energy">Past &amp; Present: Variational Free Energy</a>
  <ul class="collapse">
  <li><a href="#the-maximum-entropy-principle" id="toc-the-maximum-entropy-principle" class="nav-link" data-scroll-target="#the-maximum-entropy-principle">The Maximum Entropy Principle</a></li>
  <li><a href="#the-minimum-discription-length" id="toc-the-minimum-discription-length" class="nav-link" data-scroll-target="#the-minimum-discription-length">The Minimum Discription Length</a></li>
  <li><a href="#minimizing-divergence-maximizing-evidence" id="toc-minimizing-divergence-maximizing-evidence" class="nav-link" data-scroll-target="#minimizing-divergence-maximizing-evidence">Minimizing Divergence, Maximizing Evidence</a></li>
  </ul></li>
  <li><a href="#future-expected-free-energy" id="toc-future-expected-free-energy" class="nav-link" data-scroll-target="#future-expected-free-energy">Future: Expected Free Energy</a></li>
  <li><a href="#sec-ref" id="toc-sec-ref" class="nav-link" data-scroll-target="#sec-ref">References</a></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block page-columns page-full" id="quarto-document-content">





<p>I’ve been on a bit of a binge by reading <a href="https://academic.oup.com/book/7843">Surfing Uncertainty</a><a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>, <a href="https://www.abriefhistoryofintelligence.com/">A Brief History of Intelligence</a> (BHI), and <a href="https://direct.mit.edu/books/oa-monograph/5299/Active-InferenceThe-Free-Energy-Principle-in-Mind">Active Inference</a> and I wanted to write down most of what I’ve learned, and they all relate to the theory of active inference (and Karl Friston). These are my notes from reading the books, but also from listening to-and barely understanding-a couple of podcasts from Machine Learning Street Talk<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>.</p>
<div class="no-row-height column-margin column-container"><p><sup>1</sup>&nbsp;Scott Alexander has a decent <a href="https://slatestarcodex.com/2017/09/05/book-review-surfing-uncertainty/">review</a> of Surfing Uncertainty.</p><p><sup>2</sup>&nbsp;For a full list of references, see <a href="#sec-ref" class="quarto-xref">Section&nbsp;5</a></p></div><p>I’m primarily interested in the relationship active inference has with reinforcement learning and planning, so a lot of focus will be spent on the expected free energy. But before any of that, we have to talk about predictive processing and the bayesian brain as a warming up.</p>
<section id="the-bayesian-brain" class="level1 page-columns page-full">
<h1>The Bayesian Brain</h1>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="inpainting.png" class="img-fluid figure-img" style="width:55.0%"></p>
<figcaption>Inpainting: Perceptions ‘fills in’ the triangle.</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="one_at_a_time.png" class="img-fluid figure-img" style="width:70.0%"></p>
<figcaption>One at a Time: you can perceive either a duck or a rabbit, but not both at the same time.</figcaption>
</figure>
</div>
</div>
</div>
</div>
<p>19th century physician and physicist Herman (von) Helmholtz had a theory that could explain why such phenomena occur. Helmholtz was interested in perception, and in his work <a href="https://www.nature.com/articles/118074a0"><strong><em>Treatise on Physiological Optics</em></strong></a> we can figure out what his theory was<a href="#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>:</p>
<div class="no-row-height column-margin column-container"><p><sup>3</sup>&nbsp;Taken from <a href="https://journals.sagepub.com/doi/10.1068/p5973">Was Helmholtz a Bayesian?</a></p></div><blockquote class="blockquote">
<p>“The distinction between thought and reality is possible only when we know how to distinguish between what the ‘I’ can change and what the ‘I’ cannot change. […] What we then attain is knowledge of the lawful order in the realm of the real, but only in so far as it is represented in the tokens within the system of sensory.”</p>
</blockquote>
<p>You don’t perceive what is actually happening, you perceive what your brain <strong>thinks</strong> is there. Your brain ‘fills in’ the triangle as a suggestion of what could possibly be there. Your brain ‘sees’ either a duck or a rabbit because it picks a single reality to simulate (it’s all just a simulation).</p>
<p>Putting it a bit more (but not too) formal, the universe emits a state <span class="math inline">\(\mathbf{x}^*\)</span> but we only have access to a noisy and incomplete sensory experience of the state as observation <span class="math inline">\(\mathbf{y}\)</span>. We are constantly predicting <span class="math inline">\(\mathbf{y}\)</span> (simulating), and in doing so, we are building and strengthening our own internal model <span class="math inline">\(\mathbf{x}\)</span> that might approximate the true world model<a href="#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>.</p>
<div class="no-row-height column-margin column-container"><p><sup>4</sup>&nbsp;The universe emits a state but access is mediated by our senses <img src="helmholtz.png" class="img-fluid"></p><p><sup>5</sup>&nbsp;The paper <a href="https://www.sciencedirect.com/science/article/abs/pii/S0166223604003352">The Bayesian brain</a> is probably the most notable candidate for coining the term, but the paper actually never mentions the Bayesian Brain beyond the title.</p></div><p>Helmholtz’s ideas about the bayesian brain did not garner much attention in his time. He also didn’t coin the term Bayesian Brain - he didn’t even mention Bayes! In fact, I don’t really know who did coin the term. I asked Claude (Sonnet 3.5) and got a perfect answer: <em>“It’s likely that the term emerged organically as these ideas gained popularity in the neuroscience community.”</em>, which seems to be the most likely case<a href="#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>.</p>
<p>If you want to go a bit deeper do read Karl Friston’s <a href="https://www.sciencedirect.com/science/article/pii/S1053811911011657">The history of the future of the Bayesian brain</a>, it has a lot of nice anecdotes about Hinton too. A key takeaway from it is that the hypothesis is only a <em>description</em> of optimal behavior, it does not prescribe how decison making emerges.</p>
<p>Predictive processing somewhat builds on the idea of the Bayesian Brain, by focusing on a hierarchical probabilistic models where prediction error is central. When the brain has a mismatch between prediction and sensory input, the brain either updates its model or seeks additional information to resolve the discrepancy:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="bayesian_brain.png" class="img-fluid figure-img"></p>
<figcaption>The Bayesian Brain actively predicts incoming sensory observations. If there is a discrepancy between the brain and the world, a belief update happens in the brain.</figcaption>
</figure>
</div>
<p>From this point on many roads are possible that leave from the Bayesian Brain or Predictive Processing theories. Active Inference is one of these roads, and it adds a way to resolve predictive discrepancies.</p>
</section>
<section id="active-inference" class="level1">
<h1>Active Inference</h1>
<p>Agents are actively trying to minimize surprise. The model plays one part here, the data the other part. We can change the way the data is generated, rendering action as a complementary part to perception in inference.</p>
<blockquote class="blockquote">
<p>exact Bayesian inference supporting perception and action is computationally intractable in most cases, because two quantities—the model evidence (<span class="math inline">\(P(y)\)</span>) and the posterior probability (<span class="math inline">\(P(x \, | \, y)\)</span>)—cannot be computed for two possible reasons</p>
</blockquote>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="active_inference.png" class="img-fluid figure-img"></p>
<figcaption>Under Active Inference, perception and action are <strong>both</strong> used to realize a single objective: minimizing surprise and uncertainty.</figcaption>
</figure>
</div>
<p>To realize active inference, our generative models have to account for two notions of free energy. The first is variational free energy, and is concerned with past and present observations. The second is expected free energy, and it is concerned with planning and looking ahead into the future.</p>
</section>
<section id="past-present-variational-free-energy" class="level1">
<h1>Past &amp; Present: Variational Free Energy</h1>
<p><span class="math display">\[
\begin{align}
F[Q, y]
:&amp;= \text{Variational Free Energy} \\
&amp;= \underbrace{- \mathbb{E}_{Q(x)}[\ln P(y, x)]}_{\textit{Energy}} - \underbrace{H[Q(x)]}_{\textit{Entropy}} \\
&amp;= \underbrace{D_\text{KL}[Q(x) \, \| \, P(x)]}_{\textit{Complexity}} - \underbrace{\mathbb{E}_Q(x)[\ln P(y \, | \, x)]}_{\textit{Accuracy}} \\
&amp;= \underbrace{D_\text{KL}[Q(x) \, \| \, P(x \, | \, y)]}_{\textit{Divergence}} - \underbrace{\ln P(y)}_{\textit{Evidence}}
\end{align}
\]</span></p>
<p>We will see how three different views on the variational free energy can give us insight into what we are trying to learn in active inference.</p>
<section id="the-maximum-entropy-principle" class="level2">
<h2 class="anchored" data-anchor-id="the-maximum-entropy-principle">The Maximum Entropy Principle</h2>
<p><span class="math display">\[
F[Q, y] = \underbrace{- \mathbb{E}_{Q(x)}[\ln P(y, x)]}_{\textit{Energy}}
- \underbrace{H[Q(x)]}_{\textit{Entropy}}
\]</span></p>
<p>The first line of equation 2.5 shows that minimizing with respect to Q requires consistency with the generative model (energy) while also maintaining a high posterior entropy.</p>
<p>The latter means that, in the absence of data or precise prior beliefs (which only influence the energy term), we should adopt maximally uncertain beliefs about the hidden states of the world. This is in line the the maximum entropy principle:</p>
</section>
<section id="the-minimum-discription-length" class="level2">
<h2 class="anchored" data-anchor-id="the-minimum-discription-length">The Minimum Discription Length</h2>
<p><span class="math display">\[
F[Q, y] = \underbrace{D_\text{KL}[Q(x) \, \| \, P(x)]}_{\textit{Complexity}} - \underbrace{\mathbb{E}_Q(x)[\ln P(y \, | \, x)]}_{\textit{Accuracy}}
\]</span></p>
<p>The second line emphasizes the interpretation of free energy minimization as finding the best explanation for sensory data, which must be the simplest (minimally complex) explanation that is able to accurately account for the data (cf.&nbsp;Occam’s razor). On this view, the complexity cost is just Bayesian surprise. In other words, the degree to which “I change my mind” is quantified by the divergence between the prior and the posterior. This means every accurate explanation for my sensations incurs a complexity cost, and this cost scores the degree of Bayesian belief updating. Variational free energy, then, scores the difference between accuracy and complexity.</p>
</section>
<section id="minimizing-divergence-maximizing-evidence" class="level2">
<h2 class="anchored" data-anchor-id="minimizing-divergence-maximizing-evidence">Minimizing Divergence, Maximizing Evidence</h2>
<p><span class="math display">\[
F[Q, y] = \underbrace{D_\text{KL}[Q(x) \, \| \, P(x \, | \, y)]}_{\textit{Divergence}} - \underbrace{\ln P(y)}_{\textit{Evidence}}
\]</span></p>
<p>The final line expresses the free energy as a bound on negative log evidence (see figure 2.4). As the left part of the figure illustrates, the free energy is an upper bound on negative log evidence, where the bound is the divergence between Q and the posterior probability that would have been obtained were it possible to perform exact (as opposed to variational) infer</p>
</section>
</section>
<section id="future-expected-free-energy" class="level1">
<h1>Future: Expected Free Energy</h1>
</section>
<section id="sec-ref" class="level1">
<h1>References</h1>
<table class="table">
<thead>
<tr class="header">
<th>Type</th>
<th>Date</th>
<th>Name</th>
<th>Link</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>MLSS</td>
<td>Sep 5 2023</td>
<td>Autopoietic Enactivism and the Free Energy Principle</td>
<td><a href="https://www.youtube.com/watch?v=bL00-jtRrMA">https://www.youtube.com/watch?v=bL00-jtRrMA</a></td>
</tr>
<tr class="even">
<td>MLSS</td>
<td>Mar 2 2022</td>
<td>Prof.&nbsp;KARL FRISTON 2.0 [Unplugged]</td>
<td><a href="https://www.youtube.com/watch?v=xKQ-F2-o8uM">https://www.youtube.com/watch?v=xKQ-F2-o8uM</a></td>
</tr>
<tr class="odd">
<td>MLSS</td>
<td>Dec 13 2020</td>
<td>Karl Friston - The Free Energy Principle</td>
<td><a href="https://www.youtube.com/watch?v=KkR24ieh5Ow">https://www.youtube.com/watch?v=KkR24ieh5Ow</a></td>
</tr>
<tr class="even">
<td>MLSS</td>
<td>Mar 11 2023</td>
<td>KARL FRISTON - INTELLIGENCE 3.0</td>
<td><a href="https://www.youtube.com/watch?v=V_VXOdf1NMw">https://www.youtube.com/watch?v=V_VXOdf1NMw</a></td>
</tr>
<tr class="odd">
<td>MLSS</td>
<td>May 2 2024</td>
<td>Dr.&nbsp;THOMAS PARR - Active Inference</td>
<td><a href="https://www.youtube.com/watch?v=bk_xCikDUDQ">https://www.youtube.com/watch?v=bk_xCikDUDQ</a></td>
</tr>
<tr class="even">
<td>Book</td>
<td>Mar 29 2022</td>
<td>Active Inference (open access)</td>
<td><a href="https://mitpress.mit.edu/9780262045353/active-inference/">https://mitpress.mit.edu/9780262045353/active-inference/</a></td>
</tr>
<tr class="odd">
<td>Article</td>
<td>Feb 6 2023</td>
<td>How Our Reality May Be a Sum of All Possible Realities</td>
<td><a href="https://www.quantamagazine.org/how-our-reality-may-be-a-sum-of-all-possible-realities-20230206/">https://www.quantamagazine.org/how-our-reality-may-be-a-sum-of-all-possible-realities-20230206/</a></td>
</tr>
</tbody>
</table>


</section>


</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>